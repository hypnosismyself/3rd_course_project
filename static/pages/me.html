<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Профиль</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-light">

<nav class="navbar navbar-light bg-white border-bottom shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="/">Главная</a>
    <a class="btn btn-outline-danger" data-logout>Выйти</a>
  </div>
</nav>

<div class="container py-5">
  <div class="card shadow-sm">
    <div class="card-body">

      <div class="row align-items-center">

        <div class="col-md-3 text-center mb-4 mb-md-0">
          <img
            id="user-avatar"
            src="/assets/default-user.png"
            alt="Аватар пользователя"
            class="img-fluid rounded-circle border"
            style="max-width: 150px;"
          >
        </div>

        <div class="col-md-9">
          <h3 id="username" class="mb-2">—</h3>

          <p id="email" class="text-muted mb-1">—</p>

          <span id="role"
                class="badge bg-secondary fs-6">
            —
          </span>
        </div>

      </div>

    </div>
  </div>
</div>

<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/ui-auth.js"></script>

<script>
function getUserIdFromToken() {
  const token = localStorage.getItem('access_token');
  if (!token) return null;

  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.user_id || null;
  } catch {
    return null;
  }
}

async function fetchMe() {
  try {
    if (!window.api) return null;

    const userId = getUserIdFromToken();
    if (!userId) return null;
    return await api.get(`/users/${userId}`);
  } catch (e) {
    console.error(e);
    return null;
  }
}

document.addEventListener('DOMContentLoaded', async () => {

  if (!auth.isAuthenticated()) {
    location.href = '/pages/login.html';
    return;
  }

  const user = await fetchMe();

  if (!user) {
    alert('Не удалось загрузить профиль');
    return;
  }

  document.getElementById('username').textContent = user.username;
  document.getElementById('email').textContent = user.email || 'Почта не указана';
  document.getElementById('role').textContent = user.role;

  if (user.avatar_url) {
    document.getElementById('user-avatar').src = user.avatar_url;
  }
});
</script>

</body>
</html>
